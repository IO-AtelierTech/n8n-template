services:
  n8n:
    image: n8nio/n8n:latest
    env_file:
      - .env
    ports:
      - "${N8N_PORT}:5678"
    container_name: n8n-${CLIENT}-${PROJECT}
    volumes:
      # Mount data folder for database and other files
      - ./data:/home/node/.n8n
    restart: unless-stopped
    environment:
      # Basic settings
      - N8N_HOST=localhost
      - N8N_PORT=${N8N_PORT}
      - DB_SQLITE_VACUUM_ON_STARTUP=true
      - GENERIC_TIMEZONE=${GENERIC_TIMEZONE:-America/Mexico_City}
      - N8N_BLOCK_ENV_ACCESS_IN_NODE=false
      - N8N_COMMUNITY_PACKAGES_ENABLED=true

      # Workflows
      - WORKFLOWS_DEFAULT_NAME=${PROJECT_NAME:-Project} Workflow
      - N8N_WORKFLOW_TAGS_DISABLED=false

      # Node configuration
      - NODE_FUNCTION_ALLOW_BUILTIN=*
      - NODE_FUNCTION_ALLOW_EXTERNAL=true
      - N8N_PYTHON_ENABLED=true

      # Executions
      - EXECUTIONS_DATA_SAVE_ON_ERROR=all
      - EXECUTIONS_DATA_SAVE_ON_SUCCESS=all
      - EXECUTIONS_DATA_SAVE_MANUAL_EXECUTIONS=true
      - EXECUTIONS_DATA_PRUNE=true
      - EXECUTIONS_DATA_MAX_AGE=168

      # Disable telemetry for local development
      - N8N_DIAGNOSTICS_ENABLED=false
      - N8N_VERSION_NOTIFICATIONS_ENABLED=false
      - N8N_PERSONALIZATION_ENABLED=false

      # Log level
      - N8N_LOG_LEVEL=${N8N_LOG_LEVEL:-info}
      - N8N_LOG_OUTPUT=console

      #- GCLOUD_API_KEY=${GOOGLE_API_KEY}     
    
    networks:
      - n8n-network

  postgres:
    image: postgres:18
    container_name: postgres-${CLIENT}-${PROJECT}
    restart: unless-stopped

    environment:
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_DB=${POSTGRES_DB}

    volumes:
      - ./postgres-data:/var/lib/postgresql

    networks:
      - n8n-network


networks:
  n8n-network:
    name: n8n-${CLIENT}-${PROJECT}
    driver: bridge
